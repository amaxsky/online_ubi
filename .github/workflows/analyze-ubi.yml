name: Analyze UBI

on:
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip binwalk mtd-utils

        # 安装 ubi_reader（GitHub 源码方式）
        git clone https://github.com/jrspruitt/ubi_reader.git
        sudo python3 ubi_reader/setup.py install

    - name: Find UBI files
      id: findubi
      run: |
        echo "files=$(ls *.ubi 2>/dev/null | tr '\n' ' ')" >> $GITHUB_OUTPUT

    - name: Analyze UBI files
      if: steps.findubi.outputs.files != ''
      run: |
        for f in ${{ steps.findubi.outputs.files }}; do
          echo "=============================="
          echo "Analyzing: $f"
          echo "=============================="

          echo "--- binwalk ---"
          binwalk "$f" || true

          echo "--- ubireader_info ---"
          ubireader_info "$f" || true

          echo "--- ubireader_extract_files (structure only) ---"
          ubireader_extract_files -l "$f" || true

          echo "--- strings rootfs check ---"
          strings "$f" | grep -i rootfs || true

          echo "--- strings ubifs check ---"
          strings "$f" | grep -i ubifs || true

          echo "--- squashfs check ---"
          grep -oba "hsqs" "$f" || true

          echo "--- UBI header check ---"
          hexdump -C "$f" | grep -A1 "UBI!" | head -n 40 || true
        done

    - name: No UBI found
      if: steps.findubi.outputs.files == ''
      run: echo "No .ubi files found in repository root."
